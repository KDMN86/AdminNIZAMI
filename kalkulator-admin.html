<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kalkulator Admin</title>
    <style>
      /* reset & vars */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      :root {
        --bg: #101010;
        --fg: #f0f0f0;
        --primary: #007bff;
        --input-bg: #222;
        --border: #444;
        --transition: 0.2s;
        --success: #28a745;
        --danger: #dc3545;
      }
      body {
        margin: 0;
        padding: 1rem;
        font-family: Poppins, sans-serif;
        background: var(--bg);
        color: var(--fg);
      }
      h2 {
        text-align: center;
        margin-bottom: 0.25rem;
      }
      #currentDate {
        text-align: center;
        font-size: 0.9rem;
        color: #aaa;
        margin-bottom: 1rem;
      }

      /* dropdown multi-select */
      .dropdown {
        position: relative;
        margin-bottom: 1rem;
      }
      .dropdown-toggle {
        width: 100%;
        padding: 0.75rem 1rem;
        background: var(--input-bg);
        color: var(--fg);
        border: 1px solid var(--border);
        border-radius: 5px;
        cursor: pointer;
        user-select: none;
        transition: border-color var(--transition);
      }
      .dropdown-toggle:hover {
        border-color: var(--primary);
      }
      .dropdown-toggle::after {
        content: '▾';
        float: right;
      }
      .dropdown-menu {
        position: absolute;
        top: calc(100% + 2px);
        left: 0;
        width: 100%;
        max-height: 150px;
        overflow-y: auto;
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: 5px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 10;
      }
      .dropdown-menu.show {
        display: block;
      }
      .dropdown-menu label {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        cursor: pointer;
      }
      .dropdown-menu input {
        margin-right: 0.5rem;
      }

      /* input-group */
      .input-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .input-group input,
      .input-group button {
        min-height: 44px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        background: var(--input-bg);
        color: var(--fg);
        border: 1px solid var(--border);
        border-radius: 6px;
        transition: background var(--transition);
      }
      .input-group button {
        background: var(--primary);
        color: #fff;
        cursor: pointer;
      }
      .input-group button:hover {
        background: #0056b3;
      }

      /* table */
      .table-container {
        overflow-x: auto;
        margin-bottom: 8rem;
        padding-right: 1rem;
      }
      #captureArea {
        overflow: visible !important;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
        min-width: 600px;
      }
      th,
      td {
        border: 1px solid #555;
        padding: 0.5rem;
        text-align: center;
        font-size: 0.85rem;
        color: var(--fg);
      }
      th {
        background: var(--primary);
        color: #fff;
      }
      tfoot td {
        background: #333;
        font-weight: bold;
        color: #fff;
      }
      tr:nth-child(even) {
        background: #1a1a1a;
      }

      /* detail transaksi */
      #transaksiDetail {
        margin-top: 2rem;
        background: #fff;
        color: #000;
        padding: 1rem;
        border-radius: 8px;
        font-family: Arial, sans-serif;
      }
      #transaksiDetail h3 {
        font-size: 1.5rem;
        color: #007bff;
        margin-bottom: 0.5rem;
      }
      #transaksiDetail .tanggal {
        font-weight: bold;
        color: #37ba03;
        margin-bottom: 1rem;
        font-size: 1rem;
      }
      #transaksiDetail table {
        width: 100%;
        border-collapse: collapse;
        font-size: 1rem;
      }
      #transaksiDetail th,
      #transaksiDetail td {
        border: 2px solid #7e7e7e;
        padding: 10px;
        text-align: center;
        color: #0d0d0d;
      }
      #transaksiDetail th {
        background-color: #007bff;
        color: #fff;
      }
      #transaksiDetail tbody tr:nth-child(even) {
        background-color: #f2f2f2;
      }
      #transaksiDetail tfoot td {
        background: #ffffff;
        color: #000;
        font-weight: bold;
      }

      /* footer */
      .footer-floating {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(17, 17, 17, 0.95);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.5);
        z-index: 20;
      }
      .footer-floating .total {
        font-size: 1.1rem;
        font-weight: bold;
      }
      .footer-floating .button-row {
        display: flex;
        gap: 0.5rem;
        margin-right: 1rem;
        flex-wrap: nowrap;
      }
      .footer-floating .button-row button {
        flex: 1 1 auto;
        white-space: nowrap;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
      .footer-floating button {
        background: var(--success);
        color: #fff;
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background var(--transition);
      }
      .footer-floating button:hover {
        background: #218838;
      }

      /* === Responsive Tablet (≤900px) === */
      @media (max-width: 900px) {
        table {
          min-width: auto;
          font-size: 0.8rem;
        }
        th,
        td {
          padding: 0.4rem;
        }
        .input-group {
          gap: 0.25rem;
        }
        .input-group input,
        .input-group button {
          font-size: 0.9rem;
          padding: 0.6rem 0.8rem;
        }
        .dropdown-menu {
          max-height: 120px;
        }
        .footer-floating {
          flex-wrap: wrap;
          justify-content: center;
        }
        .footer-floating .total,
        .footer-floating .button-row {
          flex: 1 1 50%;
          text-align: center;
        }
      }

      /* === Responsive HP (≤450px) === */
      @media (max-width: 450px) {
        table {
          font-size: 0.7rem;
        }
        th,
        td {
          padding: 0.3rem;
        }
        .input-group {
          flex-direction: column;
          gap: 0.5rem;
        }
        .input-group input,
        .input-group button {
          width: 100%;
        }
        .dropdown-toggle {
          font-size: 0.9rem;
        }
        .footer-floating {
          flex-direction: column;
          align-items: stretch;
          height: auto;
        }
        .footer-floating .button-row {
          overflow-x: auto;
        }
        .footer-floating button {
          width: 100%;
        }
      }
    </style>

    <!-- html2canvas -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  </head>
  <body>
    <h2>Tambah Setoran</h2>
    <div id="currentDate"></div>

    <div class="dropdown" id="sheetDropdown">
      <div class="dropdown-toggle" id="toggleSheets">Pilih Sheet…</div>
      <div class="dropdown-menu" id="menuSheets">
        <label><input type="checkbox" value="IBU" /> IBU</label>
        <label><input type="checkbox" value="MINGGUAN" /> MINGGUAN</label>
        <label><input type="checkbox" value="FUJI" /> FUJI</label>
        <label><input type="checkbox" value="SAMSUL" /> SAMSUL</label>
        <label><input type="checkbox" value="DELI" /> DELI</label>
      </div>
    </div>

    <div class="input-group">
      <input
        type="text"
        id="grupInput"
        list="groupList"
        placeholder="Masukkan Grup ID"
      />
      <datalist id="groupList"></datalist>
      <button onclick="cariGrup()">Cek Data</button>
      <button onclick="resetTabel()">Reset</button>
    </div>

    <div id="captureArea" class="table-container">
      <table id="resultTable" class="hidden">
        <thead>
          <tr>
            <th>No</th>
            <th>Nama</th>
            <th>Paket</th>
            <th>Nilai</th>
            <th>Sebelum</th>
            <th>Jumlah</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="resultBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="6">Total</td>
            <td id="grandTotalTable">Rp 0</td>
          </tr>
        </tfoot>
      </table>

      <div id="transaksiDetail"></div>
    </div>

    <div id="calcFooter" class="footer-floating hidden">
      <div class="total">Total: <span id="grandTotalFloating">Rp 0</span></div>
      <div class="button-row">
        <button id="submitBtn" onclick="kirimSemuaSetoran()">
          Input Semua Setoran
        </button>
        <button onclick="window.print()">Cetak</button>
        <button id="saveImageBtn">Simpan JPG</button>
      </div>
    </div>

    <script>
      const API_URL =
        'https://script.google.com/macros/s/AKfycbx10POzfEL1Rv0OB2CAR2g8m8GY_hZhB3674xFYvIxJpyp7zOcRdUZVToM_l5bQVW5Y/exec';

      // dropdown logic
      const toggle = document.getElementById('toggleSheets'),
        menu = document.getElementById('menuSheets');
      const checks = menu.querySelectorAll('input[type=checkbox]');
      toggle.addEventListener('click', () => menu.classList.toggle('show'));
      document.addEventListener('click', (e) => {
        if (!document.getElementById('sheetDropdown').contains(e.target))
          menu.classList.remove('show');
      });
      function getSheetNames() {
        return Array.from(checks)
          .filter((c) => c.checked)
          .map((c) => c.value);
      }
      checks.forEach((c) =>
        c.addEventListener('change', () => {
          toggle.textContent = getSheetNames().length
            ? 'Sheet: ' + getSheetNames().join(', ')
            : 'Pilih Sheet…';
          loadGroupIds();
        })
      );

      // auth helpers
      function getToken() {
        return localStorage.getItem('adminToken') || '';
      }
      async function initAuth() {
        const t = getToken();
        if (!t) return redirect();
        let f = new FormData();
        f.append('action', 'verifyAdmin');
        f.append('token', t);
        try {
          let d = await (
            await fetch(API_URL, { method: 'POST', body: f })
          ).json();
          if (!d.success) return redirect();
        } catch {
          return redirect();
        }
        return true;
      }
      function redirect() {
        localStorage.removeItem('adminToken');
        alert('🔒 Login ulang');
        location.href = 'index.html';
      }

      // show date
      function showDate() {
        const d = new Date();
        document.getElementById('currentDate').textContent =
          'Tanggal: ' + d.toLocaleDateString('id-ID');
      }

      // load group IDs
      async function loadGroupIds() {
        let f = new FormData();
        f.append('action', 'getGroupIds');
        f.append('sheetNames', getSheetNames().join(','));
        f.append('token', getToken());
        try {
          let list = await (
            await fetch(API_URL, { method: 'POST', body: f })
          ).json();
          let dl = document.getElementById('groupList');
          dl.innerHTML = '';
          list.forEach((id) => {
            let o = document.createElement('option');
            o.value = id;
            dl.appendChild(o);
          });
        } catch {}
      }

      // cari grup
      async function cariGrup() {
        const g = document.getElementById('grupInput').value.trim();
        if (!g) return alert('Masukkan Grup ID!');
        let tbody = document.getElementById('resultBody');
        document.getElementById('resultTable').classList.remove('hidden');
        document.getElementById('calcFooter').classList.add('hidden');
        tbody.innerHTML = '<tr><td colspan="7">Loading…</td></tr>';
        let f = new FormData();
        f.append('action', 'getByGroup');
        f.append('sheetNames', getSheetNames().join(','));
        f.append('group', g);
        f.append('token', getToken());
        try {
          let data = await (
            await fetch(API_URL, { method: 'POST', body: f })
          ).json();
          if (data.error || !data.length) {
            tbody.innerHTML = `<tr><td colspan="7" style="color:red">${
              data.error || 'Data tidak ditemukan'
            }</td></tr>`;
            updateTotals();
            return;
          }
          tbody.innerHTML = data
            .map((p) => {
              let n = +p.nilaiSetoran || 0,
                m = +p.setoranDilakukan || 0;
              return `<tr data-id="${p.idPeserta}"><td>${p.no}</td><td>${
                p.nama
              }</td><td>${
                p.jenisPaket
              }</td><td>${n.toLocaleString()}</td><td>${m.toLocaleString()}</td><td><input type="number" value="0" min="0" style="width:60px" oninput="hitungSubtotal(this,${n})"></td><td class="subtotal">Rp 0</td></tr>`;
            })
            .join('');
          updateTotals();
          document.getElementById('calcFooter').classList.remove('hidden');
        } catch {
          alert('Error ambil data.');
        }
      }
      function hitungSubtotal(i, val) {
        let s = (+i.value || 0) * val;
        i.closest('tr').querySelector('.subtotal').textContent =
          'Rp ' + s.toLocaleString();
        updateTotals();
      }
      function updateTotals() {
        let t = 0;
        document
          .querySelectorAll('.subtotal')
          .forEach((c) => (t += +c.textContent.replace(/[^\d]/g, '') || 0));
        let txt = 'Rp ' + t.toLocaleString();
        document.getElementById('grandTotalTable').textContent = txt;
        document.getElementById('grandTotalFloating').textContent = txt;
      }
      function resetTabel() {
        document.getElementById('grupInput').value = '';
        document.getElementById('resultBody').innerHTML = '';
        document.getElementById('resultTable').classList.add('hidden');
        document.getElementById('calcFooter').classList.add('hidden');
        updateTotals();
        document.getElementById('transaksiDetail').innerHTML = '';
      }

      // submit & detail
      async function kirimSemuaSetoran() {
        const rows = Array.from(document.querySelectorAll('#resultBody tr'));
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.textContent = 'Memproses…';
        const sheetNames = getSheetNames().join(',');
        const tasks = rows
          .map((r) => {
            const id = r.dataset.id,
              j = +r.querySelector('input').value || 0;
            if (!id || j <= 0) return null;
            let f = new FormData();
            f.append('action', 'addSetoranMulti');
            f.append('sheetNames', sheetNames);
            f.append('idPeserta', id);
            f.append('setoranBaru', j);
            f.append('token', getToken());
            return fetch(API_URL, { method: 'POST', body: f });
          })
          .filter((x) => x);
        if (!tasks.length) {
          alert('Tidak ada setoran');
          btn.disabled = false;
          btn.textContent = 'Input Semua Setoran';
          return;
        }
        try {
          await Promise.all(tasks);
          btn.style.backgroundColor = 'var(--danger)';
          btn.textContent = 'Terkirim!';
          alert('✅ Setoran berhasil!');
        } catch (e) {
          console.error(e);
          btn.disabled = false;
          btn.textContent = 'Input Semua Setoran';
          alert('❌ ' + e.message);
        }
        // build detail
        const today = new Date().toLocaleDateString('id-ID');
        let total = 0,
          html = `<h3>Detail Transaksi</h3><div class="tanggal">Tanggal: <strong>${today}</strong></div><table style="width:100%;border-collapse:collapse"><thead><tr style="background:#333;color:#fff"><th style="padding:6px">No Peserta</th><th style="padding:6px">Nama</th><th style="padding:6px">Jumlah</th><th style="padding:6px">Subtotal</th></tr></thead><tbody>`;
        rows
          .filter((r) => +r.querySelector('input').value > 0)
          .forEach((r) => {
            const no = r.children[0].textContent,
              nama = r.children[1].textContent,
              nilai = +r.children[3].textContent.replace(/[^\d]/g, ''),
              j = +r.querySelector('input').value,
              sub = nilai * j;
            total += sub;
            html += `<tr><td style="padding:6px">${no}</td><td style="padding:6px">${nama}</td><td style="padding:6px">${j}</td><td style="padding:6px">Rp ${sub.toLocaleString(
              'id-ID'
            )}</td></tr>`;
          });
        html += `<tr style="background:#222;color:#fff"><td colspan="3" style="text-align:right;padding:6px"><strong>Total</strong></td><td style="padding:6px"><strong>Rp ${total.toLocaleString(
          'id-ID'
        )}</strong></td></tr></tbody></table>`;
        document.getElementById('transaksiDetail').innerHTML = html;
      }

      // simpan JPG detail
      document.getElementById('saveImageBtn').addEventListener('click', () => {
        const tgt = document.getElementById('transaksiDetail');
        html2canvas(tgt, {
          scrollY: -window.scrollY,
          windowWidth: document.body.scrollWidth,
          windowHeight: tgt.scrollHeight,
        }).then((canvas) => {
          let a = document.createElement('a');
          a.download = 'detail-transaksi.jpg';
          a.href = canvas.toDataURL('image/jpeg', 1.0);
          a.click();
        });
      });

      // init
      document.addEventListener('DOMContentLoaded', async () => {
        if (!(await initAuth())) return;
        showDate();
        loadGroupIds();
      });
    </script>
  </body>
</html>
