<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kalkulator Admin</title>
    <style>
      /* reset & vars */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      :root {
        --bg: #101010;
        --fg: #f0f0f0;
        --primary: #007bff;
        --input-bg: #222;
        --border: #444;
        --transition: 0.2s;
        --success: #28a745;
        --danger: #dc3545;
      }
      body {
        margin: 0;
        padding: 1rem;
        font-family: 'Poppins', sans-serif;
        background: var(--bg);
        color: var(--fg);
      }
      h2 {
        text-align: center;
        margin-bottom: 1rem;
        font-size: 1.75rem;
      }

      /* Dropdown */
      .dropdown {
        position: relative;
        margin-bottom: 1rem;
      }
      .dropdown-toggle {
        width: 100%;
        padding: 0.75rem 1rem;
        background: var(--input-bg);
        color: var(--fg);
        border: 1px solid var(--border);
        border-radius: 5px;
        cursor: pointer;
        user-select: none;
        transition: border-color var(--transition);
      }
      .dropdown-toggle:hover {
        border-color: var(--primary);
      }
      .dropdown-toggle::after {
        content: '▾';
        float: right;
      }
      .dropdown-menu {
        position: absolute;
        top: calc(100% + 2px);
        left: 0;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 10;
      }
      .dropdown-menu.show {
        display: block;
      }
      .dropdown-menu label {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        cursor: pointer;
      }
      .dropdown-menu input {
        margin-right: 0.5rem;
      }

      /* Input group */
      .input-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        margin-bottom: 1rem;
      }
      .input-group input,
      .input-group button {
        min-height: 44px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        background-color: var(--input-bg);
        color: var(--fg);
        border: 1px solid var(--border);
        border-radius: 6px;
        transition: background-color var(--transition);
      }
      .input-group input:focus,
      .input-group button:focus {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }
      .input-group button {
        cursor: pointer;
        background: var(--primary);
        color: white;
      }
      .input-group button:hover {
        background: #0056b3;
      }

      /* Table */
      .table-container {
        overflow-x: auto;
        margin-bottom: 100px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
        min-width: 600px;
      }
      th,
      td {
        border: 1px solid #555;
        padding: 0.5rem;
        text-align: center;
        font-size: 0.85rem;
        color: var(--fg);
      }
      th {
        background: var(--primary);
        color: #fff;
      }
      tfoot td {
        background: #333;
        font-weight: bold;
        color: #fff;
      }

      /* Footer */
      .footer-floating {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 70px;
        background: rgba(17, 17, 17, 0.95);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 1rem;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
        z-index: 20;
      }
      .footer-floating .total {
        font-size: 1.2rem;
        font-weight: bold;
      }
      .footer-floating button {
        background: var(--success);
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background var(--transition);
      }
      .footer-floating button:hover {
        background: #218838;
      }

      /* Responsiveness */
      @media (max-width: 600px) {
        h2 {
          font-size: 1.5rem;
        }
        .input-group {
          flex-direction: column;
          gap: 0.75rem;
        }
        table {
          min-width: 100%;
          font-size: 0.75rem;
        }
        th,
        td {
          padding: 0.4rem;
        }
        .footer-floating {
          flex-direction: column;
          height: auto;
          padding: 0.5rem;
          gap: 0.5rem;
        }
        .footer-floating .total {
          font-size: 1rem;
        }
        .footer-floating button {
          width: 100%;
          padding: 0.6rem;
        }
      }
      #currentDate {
        font-size: 1rem;
        color: var(--fg);
        opacity: 0.75;
        text-align: center;
        margin-bottom: 0.5rem;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h2>Tambah Setoran</h2>
    <div id="currentDate"></div>

    <!-- custom dropdown multi-select -->
    <div class="dropdown" id="sheetDropdown">
      <div class="dropdown-toggle" id="toggleSheets">Pilih Sheet…</div>
      <div class="dropdown-menu" id="menuSheets">
        <label><input type="checkbox" value="IBU" /> IBU</label>
        <label><input type="checkbox" value="MINGGUAN" /> MINGGUAN</label>
        <label><input type="checkbox" value="FUJI" /> FUJI</label>
        <label><input type="checkbox" value="SAMSUL" /> SAMSUL</label>
        <label><input type="checkbox" value="DELI" /> DELI</label>
      </div>
    </div>

    <div class="input-group">
      <input
        type="text"
        id="grupInput"
        list="groupList"
        placeholder="Masukkan Grup ID"
      />
      <datalist id="groupList"></datalist>
      <button onclick="cariGrup()">Cek Data</button>
      <button onclick="resetTabel()">Reset</button>
    </div>

    <div class="table-container">
      <table id="resultTable" class="hidden">
        <thead>
          <tr>
            <th>No</th>
            <th>Nama</th>
            <th>Jenis Paket</th>
            <th>Nilai Setoran (Rp)</th>
            <th>Setoran Sebelumnya</th>
            <th>Jumlah Setoran</th>
            <th>Subtotal (Rp)</th>
          </tr>
        </thead>
        <tbody id="resultBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="6">Total</td>
            <td id="grandTotalTable">Rp 0</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div id="calcFooter" class="footer-floating hidden">
      <div class="total">Total: <span id="grandTotalFloating">Rp 0</span></div>
      <button id="submitBtn" onclick="kirimSemuaSetoran()">
        Input Semua Setoran
      </button>
    </div>

    <script>
      const API_URL =
        'https://script.google.com/macros/s/AKfycbz5ngg1M4aW2RjYLgcwm5lYXGealgaih-1rd7rCoQJv_bamrudmsJkAWLEcBUk2BzOF/exec';

      // — Multi-sheet dropdown logic —
      const toggle = document.getElementById('toggleSheets');
      const menu = document.getElementById('menuSheets');
      const checks = menu.querySelectorAll('input[type=checkbox]');

      toggle.addEventListener('click', () => menu.classList.toggle('show'));
      document.addEventListener('click', (e) => {
        if (!document.getElementById('sheetDropdown').contains(e.target)) {
          menu.classList.remove('show');
        }
      });

      function getSheetNames() {
        return Array.from(checks)
          .filter((c) => c.checked)
          .map((c) => c.value);
      }
      checks.forEach((c) =>
        c.addEventListener('change', () => {
          const sel = getSheetNames();
          toggle.textContent = sel.length
            ? 'Sheet: ' + sel.join(', ')
            : 'Pilih Sheet…';
          loadGroupIds();
        })
      );

      // — Auth helpers —
      function getToken() {
        return localStorage.getItem('adminToken') || '';
      }
      async function initAuth() {
        const token = getToken();
        if (!token) return redirectLogin();
        const f = new FormData();
        f.append('action', 'verifyAdmin');
        f.append('token', token);
        try {
          const d = await (
            await fetch(API_URL, { method: 'POST', body: f })
          ).json();
          if (!d.success) return redirectLogin();
          return true;
        } catch {
          return redirectLogin();
        }
      }
      function redirectLogin() {
        localStorage.removeItem('adminToken');
        alert('🔒 Token tidak valid. Silakan login ulang.');
        location.href = 'index.html';
      }

      // — Load Group ID autocomplete —
      async function loadGroupIds() {
        const sheets = getSheetNames().join(',');
        const f = new FormData();
        f.append('action', 'getGroupIds');
        f.append('sheetNames', sheets);
        f.append('token', getToken());
        try {
          const list = await (
            await fetch(API_URL, { method: 'POST', body: f })
          ).json();
          const dl = document.getElementById('groupList');
          dl.innerHTML = '';
          list.forEach((id) => {
            const o = document.createElement('option');
            o.value = id;
            dl.appendChild(o);
          });
        } catch (e) {
          console.error('Gagal load grup IDs', e);
        }
      }

      // — Fetch and render participants by group —
      async function cariGrup() {
        const grup = document.getElementById('grupInput').value.trim();
        if (!grup) return alert('Masukkan Grup ID!');
        const tbody = document.getElementById('resultBody');
        document.getElementById('resultTable').classList.remove('hidden');
        document.getElementById('calcFooter').classList.add('hidden');
        tbody.innerHTML = '<tr><td colspan="7">Loading…</td></tr>';

        const f = new FormData();
        f.append('action', 'getByGroup');
        f.append('sheetNames', getSheetNames().join(','));
        f.append('group', grup);
        f.append('token', getToken());

        try {
          const data = await (
            await fetch(API_URL, { method: 'POST', body: f })
          ).json();
          if (data.error || !data.length) {
            tbody.innerHTML = `<tr><td colspan="7" style="color:red;">${
              data.error || 'Data tidak ditemukan'
            }</td></tr>`;
            updateTotals();
            return;
          }
          tbody.innerHTML = data
            .map((p) => {
              const n = +p.nilaiSetoran || 0,
                m = +p.setoranDilakukan || 0;
              return `<tr data-id="${p.idPeserta}">
              <td>${p.no}</td><td>${p.nama}</td><td>${p.jenisPaket}</td>
              <td>${n.toLocaleString()}</td><td>${m.toLocaleString()}</td>
              <td><input type="number" value="0" min="0" style="width:60px" oninput="hitungSubtotal(this,${n})"></td>
              <td class="subtotal">Rp 0</td>
            </tr>`;
            })
            .join('');
          updateTotals();
          document.getElementById('calcFooter').classList.remove('hidden');
        } catch (e) {
          console.error(e);
          alert('Error ambil data.');
        }
      }

      function hitungSubtotal(input, val) {
        const sub = (+input.value || 0) * val;
        input.closest('tr').querySelector('.subtotal').textContent =
          'Rp ' + sub.toLocaleString();
        updateTotals();
      }
      function updateTotals() {
        let t = 0;
        document
          .querySelectorAll('.subtotal')
          .forEach((c) => (t += +c.textContent.replace(/[^\d]/g, '') || 0));
        const txt = 'Rp ' + t.toLocaleString();
        document.getElementById('grandTotalTable').textContent = txt;
        document.getElementById('grandTotalFloating').textContent = txt;
      }
      function resetTabel() {
        document.getElementById('grupInput').value = '';
        document.getElementById('resultBody').innerHTML = '';
        document.getElementById('resultTable').classList.add('hidden');
        document.getElementById('calcFooter').classList.add('hidden');
        updateTotals();
      }

      // — Submit all deposits to Apps Script as addSetoranMulti —
      async function kirimSemuaSetoran() {
        const rows = document.querySelectorAll('#resultBody tr');
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.textContent = 'Memproses…';

        const sheetNames = getSheetNames().join(',');
        const tasks = Array.from(rows)
          .map((r) => {
            const id = r.dataset.id,
              j = +r.querySelector('input').value || 0;
            if (!id || j <= 0) return null;
            const f = new FormData();
            f.append('action', 'addSetoranMulti');
            f.append('sheetNames', sheetNames);
            f.append('idPeserta', id);
            f.append('setoranBaru', j);
            f.append('token', getToken());
            return fetch(API_URL, { method: 'POST', body: f });
          })
          .filter((x) => x);

        if (!tasks.length) {
          alert('Tidak ada setoran untuk dikirim');
          btn.disabled = false;
          btn.textContent = 'Input Semua Setoran';
          return;
        }

        try {
          await Promise.all(tasks);
          btn.style.backgroundColor = 'var(--danger)';
          btn.textContent = 'Terkirim!';
          alert('✅ Semua setoran berhasil dikirim!');
        } catch (e) {
          console.error(e);
          btn.disabled = false;
          btn.textContent = 'Input Semua Setoran';
          alert('❌ Error: ' + e.message);
        }
      }

      // — Initialize on load —
      document.addEventListener('DOMContentLoaded', async () => {
        if (!(await initAuth())) return;
        loadGroupIds();
      });

      function formatDate(d) {
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yy = d.getFullYear();
        return dd + '/' + mm + '/' + yy;
      }
      function showCurrentDate() {
        const el = document.getElementById('currentDate');
        if (el) el.textContent = 'Tanggal: ' + formatDate(new Date());
      }
      document.addEventListener('DOMContentLoaded', async () => {
        if (!(await initAuth())) return;
        showCurrentDate();
        loadGroupIds();
      });
    </script>
  </body>
</html>
